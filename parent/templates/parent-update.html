{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
    <body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex min-h-screen w-full flex-col group/design-root">
        <div class="flex flex-1">

            <main class="flex-1 p-6 sm:p-8 lg:p-10">
                <div class="max-w-4xl mx-auto">

                    <div class="flex flex-wrap gap-2 mb-4 pt-4">
                        <a class="text-[#618961] dark:text-gray-400 text-sm font-medium leading-normal hover:underline"
                           href="{% url 'list_parent' %}">Rodzice</a>
                        <span class="text-[#618961] dark:text-gray-400 text-sm font-medium leading-normal">/</span>
                        <a class="text-[#618961] dark:text-gray-400 text-sm font-medium leading-normal hover:underline"
                           href="{% url 'parent_profile' pk=parent.id %}">{{ parent.first_name|default:parent.user.email }}</a>
                        <span class="text-[#618961] dark:text-gray-400 text-sm font-medium leading-normal">/</span>
                        <span class="text-[#111811] dark:text-white text-sm font-medium leading-normal">Edycja</span>
                    </div>

                    <div class="flex flex-wrap justify-between gap-3 mb-8">
                        <h1 class="text-[#111811] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">
                            Edytuj Profil Rodzica</h1>
                    </div>

                    {% if form.errors %}
                        <div class="p-3 mb-4 rounded-lg text-white text-center font-semibold bg-red-600" role="alert">
                            Wystąpił błąd walidacji. Proszę sprawdzić pola oznaczone na czerwono.
                        </div>
                    {% endif %}

                    <div class="bg-white dark:bg-zinc-900/50 rounded-xl border border-gray-200 dark:border-gray-800">

                        <form method="post" action="{% url 'parent_update' pk=parent.id %}"
                              enctype="multipart/form-data">
                            {% csrf_token %}

                            <div class="flex p-6 @container border-b border-gray-200 dark:border-gray-800 pb-6">
                                <div class="flex w-full flex-col gap-4 @[520px]:flex-row @[520px]:justify-between @[520px]:items-center">
                                    <div class="flex gap-4 items-center">
                                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-16 w-16">
                                            {% if parent.gender == 2 %}
                                                <img class="rounded-full w-16 h-16 object-cover"
                                                     src="{% static 'parent_female.jpg' %}" alt="Avatar kobiety"/>
                                            {% elif parent.gender == 1 %}
                                                <img class="rounded-full w-16 h-16 object-cover"
                                                     src="{% static 'parent_male.jpg' %}" alt="Avatar mężczyzny"/>
                                            {% else %}
                                                <img class="rounded-full w-16 h-16 object-cover"
                                                     src="{% static 'gander_null.jpg' %}" alt="Avatar neutralny"/>
                                            {% endif %}
                                        </div>
                                        <div class="flex flex-col justify-center">
                                            <p class="text-[#111811] dark:text-white text-base font-medium">{{ parent.first_name }} {{ parent.last_name }}</p>
                                            <p class="text-[#618961] dark:text-gray-400 text-sm">{{ parent.user.email }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-6">
                                <h3 class="text-[#111811] dark:text-white text-xl font-bold leading-tight tracking-[-0.015em] pb-3 border-b border-gray-200 dark:border-gray-800">
                                    Dane Osobowe i Kontaktowe</h3>

                                <div class="space-y-10">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">

                                        {% comment %} DEFINICJA MAKR W STYLU JINJA (ALE KORZYSTAMY Z CZYSTEGO KODU HTML W PĘTLI) {% endcomment %}

                                        {% for field in form %}
                                            {# Pomijamy ukryte pola, które już wyrenderowaliśmy #}
                                            {% if not field.is_hidden %}
                                                {% if field.name == 'user' or field.name == 'principal' %}
                                                    {{ field.as_hidden }}
                                                    {% else %}
                                                    <div class="{% if field.name == 'address' %}md:col-span-2{% endif %}">

                                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                                                               for="{{ field.id_for_label }}">
                                                            {{ field.label }}
                                                        </label>

                                                        {# Nadajemy klasy Tailwind bezpośrednio na widżet #}
                                                        <div class="relative">

                                                            {% with error_class="border-red-500 dark:border-red-500 focus:border-red-500 focus:ring-red-500/50" %}
                                                                {% with default_class="border-gray-300 dark:border-gray-700 focus:border-primary focus:ring-primary/50" %}
                                                                    {% with base_class="w-full rounded-lg p-3 text-base bg-white dark:bg-gray-900 text-[#111811] dark:text-white focus:outline-none focus:ring-2 border" %}

                                                                        {# Renderowanie pola tekstowego/numerycznego #}
                                                                        {% if field.field.widget.input_type != 'select' %}
                                                                            <input type="{{ field.field.widget.input_type }}"
                                                                                   id="{{ field.id_for_label }}"
                                                                                   name="{{ field.name }}"
                                                                                   value="{{ field.value|default:'' }}"
                                                                                   placeholder="{{ field.label }}"
                                                                                   class="{{ base_class }} {{ field.css_classes }}

                                                                                       {% if field.errors %}{{ error_class }}{% else %}{{ default_class }}{% endif %}"
                                                                                   {% if field.field.required %}required{% endif %}
                                                                            />
                                                                        {% else %}
                                                                            {# Renderowanie pola SELECT (Pole Płeć) #}
                                                                            <select id="{{ field.id_for_label }}"
                                                                                    name="{{ field.name }}"
                                                                                    class="{{ base_class }} appearance-none pr-10

                                                                                        {% if field.errors %}{{ error_class }}{% else %}{{ default_class }}{% endif %}">
                                                                                {% for value, label in field.field.choices %}
                                                                                    <option value="{{ value }}"
                                                                                            {% if field.value == value|stringformat:"s" or field.value == value %}selected{% endif %}>{{ label }}</option>
                                                                                {% endfor %}
                                                                            </select>

                                                                        {% endif %}

                                                                    {% endwith %}
                                                                {% endwith %}
                                                            {% endwith %}
                                                        </div>

                                                        {# Wyświetlanie błędu (Poprawione) #}
                                                        {% if field.errors %}
                                                            <p class="text-sm text-red-600 dark:text-red-400 mt-1">
                                                                {# Używamy .as_text, aby uzyskać czysty komunikat błędu #}
                                                                {{ field.errors.as_text }}
                                                            </p>
                                                        {% endif %}

                                                    </div>
                                                    {% endif %}

                                            {% endif %}
                                        {% endfor %}

                                    </div>
                                </div>
                            </div>


                            <div class="flex justify-end gap-4 p-4 border-t border-gray-200 dark:border-gray-800 rounded-b-xl bg-gray-50 dark:bg-zinc-900/50">
                                <a href="{% url 'parent_profile' pk=parent.id %}"
                                   class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-11 px-6 bg-gray-100 dark:bg-gray-800 text-[#111811] dark:text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <span class="truncate">Anuluj</span>
                                </a>
                                <button type="submit"
                                        class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-11 px-6 bg-primary text-black text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90">
                                    <span class="truncate">Zapisz Zmiany</span>
                                </button>
                            </div>

                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>
    </body>
{% endblock %}