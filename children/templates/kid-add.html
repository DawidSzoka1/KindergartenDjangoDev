{% extends "base.html" %}
{% load static %}

{% block content %}

    <div class="mx-auto max-w-5xl">

        <!-- Nagłówek -->
        <div class="mb-10 flex flex-wrap items-center justify-between gap-6">
            <h1 class="text-4xl font-black tracking-tight text-gray-900 dark:text-white">
                Dodaj nowe dziecko
            </h1>
            <a href="{% url 'list_kids' %}" class="flex items-center gap-2 text-primary hover:underline font-medium">
                <span class="material-symbols-outlined text-xl">arrow_back</span>
                Powrót do listy
            </a>
        </div>

        <!-- OGÓLNE BŁĘDY FORMULARZA -->
        {% if form.non_field_errors %}
            <div class="mb-8 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 p-5">
                <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-red-600 mt-0.5">error</span>
                    <div>
                        <p class="font-semibold text-red-800 dark:text-red-300">Wystąpiły błędy:</p>
                        <ul class="mt-2 list-disc list-inside text-red-700 dark:text-red-200">
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}

        <form method="post" class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-8 shadow-lg">
            {% csrf_token %}

            <!-- Informacje o dziecku -->
            <section class="mb-10">
                <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">Informacje o dziecku</h2>
                <div class="grid grid-cols-1 gap-6 md:grid-cols-2">

                    <!-- Imię -->
                    <div>
                        <label class="mb-2 block text-sm font-semibold">Imię <span class="text-red-600">*</span></label>
                        <input type="text" name="first_name" value="{{ form.first_name.value|default:'' }}" required
                               class="h-12 w-full rounded-lg border {% if form.first_name.errors %}border-red-500 dark:border-red-400{% else %}border-gray-300 dark:border-gray-600{% endif %} bg-white dark:bg-gray-800 px-4 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20">
                        {% if form.first_name.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">error</span>
                                {{ form.first_name.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <!-- Nazwisko -->
                    <div>
                        <label class="mb-2 block text-sm font-semibold">Nazwisko <span class="text-red-600">*</span></label>
                        <input type="text" name="last_name" value="{{ form.last_name.value|default:'' }}" required
                               class="h-12 w-full rounded-lg border {% if form.last_name.errors %}border-red-500 dark:border-red-400{% else %}border-gray-300 dark:border-gray-600{% endif %} bg-white dark:bg-gray-800 px-4 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20">
                        {% if form.last_name.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">error</span>
                                {{ form.last_name.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <!-- Data urodzenia -->
                    <div>
                        <label class="mb-2 block text-sm font-semibold">Data urodzenia <span class="text-red-600">*</span></label>
                        <div class="relative">
                            <input type="date" name="date_of_birth" value="{{ form.date_of_birth.value|date:'Y-m-d' }}" required
                                   class="h-12 w-full rounded-lg border {% if form.date_of_birth.errors %}border-red-500{% else %}border-gray-300 dark:border-gray-600{% endif %} bg-white dark:bg-gray-800 px-4 pr-12 focus:border-primary focus:outline-none">

                        </div>
                        {% if form.date_of_birth.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">error</span>
                                {{ form.date_of_birth.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <!-- Płeć -->
                    <div>
                        <label class="mb-2 block text-sm font-semibold">Płeć</label>
                        <select name="gender" class="h-12 w-full rounded-lg border {% if form.gender.errors %}border-red-500{% else %}border-gray-300 dark:border-gray-600{% endif %} bg-white dark:bg-gray-800 px-4 focus:border-primary">
                            <option value="">--- Wybierz ---</option>
                            <option value="1" {% if form.gender.value == "Chłopiec" %}selected{% endif %}>Chłopiec</option>
                            <option value="2" {% if form.gender.value == "Dziewczynka" %}selected{% endif %}>Dziewczynka</option>
                        </select>
                        {% if form.gender.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">error</span>
                                {{ form.gender.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                </div>
            </section>

            <!-- Rodzic – Select2 -->
            <section class="mb-10">
                <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">Rodzic / Opiekun <span class="text-red-600">*</span></h2>
                <div class="max-w-2xl flex items-end gap-4">
                    <div class="flex-1">
                        <label class="mb-2 block text-sm font-semibold">Wybierz rodzica</label>
                        <div class="relative">
                            <select name="parents" id="parents-select" required class="js-select2 w-full">
                                <option value="">--- Wybierz rodzica ---</option>
                                {% for parent in form.fields.parents.queryset %}
                                    <option value="{{ parent.pk }}">{{ parent.user.username|default:'' }} ({{ parent.user.email }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="button" onclick="openAddParentModal()" class="mb-1 whitespace-nowrap rounded-lg bg-green-600 px-5 py-3 text-white font-medium hover:bg-green-700 shadow-md flex items-center gap-2">
                        <span class="material-symbols-outlined text-xl">person_add</span>
                        Dodaj rodzica
                    </button>
                </div>
                {% if form.principal.errors %}
                    <p class="mt-2 text-sm text-red-600 flex items-center gap-1"><span class="material-symbols-outlined text-xs">error</span> {{ form.principal.errors|join:", " }}</p>
                {% endif %}
            </section>

            <!-- Opcjonalne: grupa, plan, posiłki -->
            <section class="mb-10">
                <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">Dodatkowe informacje (opcjonalne)</h2>
                <div class="grid grid-cols-1 gap-6 md:grid-cols-3">

                    <div>
                        <label class="mb-2 block text-sm font-semibold">Grupa</label>
                        <div class="relative">
                            <select name="group" class="h-12 w-full rounded-lg border {% if form.group.errors %}border-red-500{% else %}border-gray-300 dark:border-gray-600{% endif %} bg-white dark:bg-gray-800 px-4 pr-12">
                                <option value="">--- Brak grupy ---</option>
                                {% for group in form.fields.group.queryset %}
                                    <option value="{{ group.pk }}" {% if form.group.value == group.pk %}selected{% endif %}>{{ group.name }}</option>
                                {% endfor %}
                            </select>

                        </div>
                    </div>

                    <div>
                        <label class="mb-2 block text-sm font-semibold">Plan płatności</label>
                        <select name="payment_plan" class="h-12 w-full rounded-lg border {% if form.payment_plan.errors %}border-red-500{% else %}border-gray-300 dark:border-gray-600{% endif %} bg-white dark:bg-gray-800 px-4">
                            <option value="">--- Brak ---</option>
                            {% for plan in form.fields.payment_plan.queryset %}
                                <option value="{{ plan.pk }}" {% if form.payment_plan.value == plan.pk %}selected{% endif %}>{{ plan.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="mb-2 block text-sm font-semibold">Posiłki</label>
                        <select name="kid_meals" class="h-12 w-full rounded-lg border {% if form.kid_meals.errors %}border-red-500{% else %}border-gray-300 dark:border-gray-600{% endif %} bg-white dark:bg-gray-800 px-4">
                            <option value="">--- Brak ---</option>
                            {% for meal in form.fields.kid_meals.queryset %}
                                <option value="{{ meal.pk }}" {% if form.kid_meals.value == meal.pk %}selected{% endif %}>{{ meal.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                </div>
            </section>

            <!-- Okres pobytu -->
            <section class="mb-10">
                <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">Okres pobytu</h2>
                <div class="grid grid-cols-1 gap-6 md:grid-cols-2">

                    <div>
                        <label class="mb-2 block text-sm font-semibold">Data rozpoczęcia <span class="text-red-600">*</span></label>
                        <div class="relative">
                            <input type="date" name="start" value="{{ form.start.value|date:'Y-m-d' }}" required
                                   class="h-12 w-full rounded-lg border {% if form.start.errors %}border-red-500{% else %}border-gray-300 dark:border-gray-600{% endif %} bg-white dark:bg-gray-800 px-4 pr-12">

                        </div>
                        {% if form.start.errors %}
                            <p class="mt-1 text-sm text-red-600 flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">error</span>
                                {{ form.start.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <div id="end-date-container">
                        <label class="mb-2 block text-sm font-semibold">Data zakończenia <span class="text-gray-500">(opcjonalnie)</span></label>
                        <div class="relative">
                            <input type="date" name="end" value="{{ form.end.value|date:'Y-m-d' }}"
                                   class="h-12 w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 pr-12">

                        </div>
                    </div>
                </div>

                <div class="mt-6 flex items-center gap-3">
                    <input type="checkbox" id="indefinite" name="indefinite" class="h-5 w-5 rounded text-primary"
                           onchange="toggleEndDate()" {% if form.indefinite.value %}checked{% endif %}>
                    <label for="indefinite" class="text-base font-medium cursor-pointer">Umowa na czas nieokreślony</label>
                </div>
            </section>

            <!-- Przyciski -->
            <div class="flex flex-col gap-4 sm:flex-row sm:justify-end border-t border-gray-200 dark:border-gray-700 pt-8">
                <a href="{% url 'list_kids' %}" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-8 py-3 text-center font-medium hover:bg-gray-100 dark:hover:bg-gray-700">
                    Anuluj
                </a>
                <button type="submit" class="rounded-lg bg-primary px-8 py-3 font-medium text-white hover:bg-primary/90 shadow-md">
                    Dodaj dziecko
                </button>
            </div>
        </form>
    </div>
    <script>
        function openAddParentModal() {
            document.getElementById('add-parent-modal').classList.remove('hidden');
            document.getElementById('new-parent-email').focus();
        }

        function closeAddParentModal() {
            document.getElementById('add-parent-modal').classList.add('hidden');
            document.getElementById('new-parent-email').value = '';
        }

        function createParentAndSelect() {
            const email = document.getElementById('new-parent-email').value.trim();
            if (!email || !email.includes('@')) {
                alert('Wpisz poprawny adres e-mail!');
                return;
            }

            const spinner = document.getElementById('create-parent-spinner');
            const text = document.getElementById('create-parent-text');

            // Pokaż ładowanie
            if (spinner) spinner.classList.remove('hidden');
            if (text) text.classList.add('hidden');

            fetch("{% url 'create_parent_ajax' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ email: email })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 1. Znajdź select obsługiwany przez Select2
                        const $select = $('#parents-select');

                        // 2. Stwórz nową opcję (tekst, wartość, zaznaczona, wybrana)
                        const newOption = new Option(data.email, data.parent_id, true, true);

                        // 3. Dodaj do selecta i wymuś odświeżenie Select2
                        $select.append(newOption).trigger('change');

                        // 4. Zamknij modal i wyczyść pole
                        closeAddParentModal();

                        // Opcjonalne powiadomienie (możesz usunąć alert dla lepszego UX)
                        console.log("Dodano rodzica: " + data.email);
                    } else {
                        alert("Błąd: " + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Wystąpił błąd podczas komunikacji z serwerem.');
                })
                .finally(() => {
                    // Przywróć przycisk
                    if (spinner) spinner.classList.add('hidden');
                    if (text) text.classList.remove('hidden');
                });
        }
    </script>

    <!-- Select2 init -->
    <script>
        $(document).ready(function() {
            $('.js-select2').select2({
                placeholder: "Szukaj rodzica...",
                allowClear: true
            });
        });
    </script>
    <script>

        $(document).ready(function() {
            $('.js-select2').select2({
                placeholder: "Szukaj rodzica po imieniu lub emailu...",
                allowClear: true
            });
        });

        function toggleEndDate() {
            const container = document.getElementById('end-date-container');
            const input = container.querySelector('input');
            if (document.getElementById('indefinite').checked) {
                container.style.display = 'none';
                input.value = '';
                input.removeAttribute('required');
            } else {
                container.style.display = 'block';
            }
        }
        document.addEventListener('DOMContentLoaded', toggleEndDate);
    </script>

{% endblock %}