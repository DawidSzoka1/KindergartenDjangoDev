{% extends "base.html" %}
{% load static %}

{% block content %}
    <main class="flex-1 p-4 lg:p-8 w-full max-w-5xl mx-auto">
        <nav class="flex items-center gap-2 mb-6 text-sm font-medium">
            <a href="{% url 'home_page' %}" class="text-[#618961] dark:text-gray-400 hover:text-primary transition-colors">Dashboard</a>
            <span class="text-gray-400">/</span>
            <span class="text-[#111811] dark:text-white">Lista Obecności</span>
        </nav>

        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-[#111811] dark:text-white tracking-tight uppercase">Zarządzanie Obecnością</h1>
                <p class="text-[#618961] dark:text-gray-400">Dzisiaj jest {{ today|date:"l, d F Y" }}</p>
            </div>

            {% if perms.director.is_director %}
                <form method="POST" action="" class="relative w-full md:w-72">
                    {% csrf_token %}
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="material-symbols-outlined text-gray-400">search</span>
                    </div>
                    <input type="text" name="search" placeholder="Szukaj dziecka..."
                           class="block w-full pl-10 pr-3 py-2 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl focus:ring-primary focus:border-primary text-sm">
                </form>
            {% endif %}
        </div>


        {% if weekend %}
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-12 text-center border border-dashed border-gray-300 dark:border-gray-700">
                <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">event_busy</span>
                <h2 class="text-2xl font-bold text-gray-500">Weekend / Dzień wolny od zajęć</h2>
            </div>
        {% else %}
            <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800">
                <div class="divide-y divide-gray-100 dark:divide-gray-800">
                    {% for kid, presence in dict.items %}
                        <div class="p-4 sm:p-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all">
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    {% if kid.gender == 2 %}
                                        <img class="h-14 w-14 rounded-full object-cover border-2 border-primary/20" src="{% static 'girl.jpg' %}" alt="{{ kid.first_name }}">
                                    {% else %}
                                        <img class="h-14 w-14 rounded-full object-cover border-2 border-primary/20" src="{% static 'boy.jpg' %}" alt="{{ kid.first_name }}">
                                    {% endif %}
                                    <div class="absolute -bottom-1 -right-1 size-4 rounded-full border-2 border-white dark:border-gray-900
                                {% if presence.presenceType == 2 %}bg-green-500{% elif presence.presenceType == 3 %}bg-blue-500{% else %}bg-red-500{% endif %}">
                                    </div>
                                </div>
                                <div>
                                    <a href="{% url 'kid_details' pk=kid.id %}" class="text-lg font-bold text-[#111811] dark:text-white hover:text-primary transition-colors">
                                        {{ kid.first_name.title }} {{ kid.last_name.title }}
                                    </a>
                                    <p class="text-sm text-[#618961] dark:text-gray-400">Grupa: {{ kid.group.name|default:"Brak grupy" }}</p>
                                </div>
                            </div>

                            <div class="flex items-center gap-3">
                                <form method="POST" action="" class="flex items-center">
                                    {% csrf_token %}
                                    {% if perms.teacher.is_teacher or perms.director.is_director %}
                                        {% if presence.presenceType == 2 %}
                                            <button type="submit" name="data" value="{{ kid.id }} 1"
                                                    onclick="return confirm('Cofnąć obecność dla: {{ kid }}?');"
                                                    class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-xl font-bold text-sm hover:bg-green-600 transition-all">
                                                <span class="material-symbols-outlined !text-lg">check_circle</span>
                                                OBECNY
                                            </button>
                                        {% elif presence.presenceType == 3 %}
                                            <div class="px-4 py-2 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-xl font-bold text-sm flex items-center gap-2">
                                                <span class="material-symbols-outlined !text-lg">event_busy</span>
                                                ZAPLANOWANA
                                            </div>
                                        {% else %}
                                            <button type="submit" name="data" value="{{ kid.id }} 2"
                                                    class="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 text-gray-400 rounded-xl font-bold text-sm hover:bg-primary/20 hover:text-primary transition-all">
                                                <span class="material-symbols-outlined !text-lg">radio_button_unchecked</span>
                                                OZNACZ OBECNOŚĆ
                                            </button>
                                        {% endif %}
                                    {% elif perms.parent.is_parent %}
                                        {% if tomorrow == 5 or tomorrow == 6 %}
                                            <span class="text-xs text-gray-400 italic">Jutro wolne</span>
                                        {% else %}
                                            <button type="submit" name="data" value="{{ kid.id }} 3"
                                                    class="flex items-center gap-2 px-4 py-2 bg-orange-100 text-orange-700 rounded-xl font-bold text-sm hover:bg-orange-200 transition-all">
                                                <span class="material-symbols-outlined !text-lg">history_toggle_off</span>
                                                ZGŁOŚ NIEOBECNOŚĆ
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </form>

                                <div class="relative group">
                                    <button class="p-2 text-gray-400 hover:text-primary rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-all">
                                        <span class="material-symbols-outlined">more_vert</span>
                                    </button>

                                    <div class="absolute right-0 top-full pt-2 w-48 hidden group-hover:block z-[100]">
                                        <div class="bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-800 rounded-xl shadow-2xl overflow-hidden">
                                            <a href="{% url 'kid_details' pk=kid.id %}" class="flex items-center gap-2 px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary transition-colors">
                                                <span class="material-symbols-outlined !text-lg">account_circle</span> Profil
                                            </a>
                                            <a href="{% url 'calendar' kid.id month year %}" class="flex items-center gap-2 px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary transition-colors">
                                                <span class="material-symbols-outlined !text-lg">calendar_month</span> Kalendarz
                                            </a>
                                            {% if perms.director.is_director %}
                                                <div class="border-t border-gray-100 dark:border-gray-800"></div>
                                                <a href="{% url 'change_kid_info' pk=kid.id %}" class="flex items-center gap-2 px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary transition-colors">
                                                    <span class="material-symbols-outlined !text-lg">edit</span> Edytuj
                                                </a>
                                                <form method="POST" action="{% url 'kid_delete' pk=kid.id %}" onsubmit="return confirm('Usunąć dziecko {{ kid }}?');">
                                                    {% csrf_token %}
                                                    <button type="submit" name="delete" class="w-full flex items-center gap-2 px-4 py-3 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors">
                                                        <span class="material-symbols-outlined !text-lg">delete</span> Usuń
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                {% if page_obj.has_other_pages %}
                    <div class="p-4 bg-gray-50 dark:bg-gray-800/30 border-t border-gray-100 dark:border-gray-800 flex justify-center gap-2">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}" class="size-10 flex items-center justify-center rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-gray-500 hover:border-primary hover:text-primary transition-all">
                                <span class="material-symbols-outlined">chevron_left</span>
                            </a>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="size-10 flex items-center justify-center rounded-xl bg-primary text-black font-bold">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?page={{ num }}" class="size-10 flex items-center justify-center rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-gray-500 hover:border-primary hover:text-primary transition-all">{{ num }}</a>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}" class="size-10 flex items-center justify-center rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-gray-500 hover:border-primary hover:text-primary transition-all">
                                <span class="material-symbols-outlined">chevron_right</span>
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </main>
{% endblock %}