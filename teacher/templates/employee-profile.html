{% extends "base.html" %}
{% load static %}

{% block content %}
    <body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden"
         x-data="{ currentTab: 'overview', showAssignmentModal: false }">

        <div class="flex h-full min-w-0 flex-1 flex-col">
            <main class="flex flex-1 flex-col p-4 md:p-6 lg:p-8">
                <div class="w-full max-w-7xl mx-auto">

                    <div class="flex items-center gap-3 mb-4 pt-4">
                        {% if active_role == 'director' %}
                        <a href="{% url 'list_teachers' %}" class="flex items-center gap-2 text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors">
                            <span class="material-symbols-outlined text-3xl">arrow_back</span>
                            <span class="text-xl font-medium leading-normal hidden sm:inline">KADRA</span>
                        </a>
                        {% endif %}
                        <span class="text-[#618961] dark:text-gray-400 text-sm font-medium leading-normal">/</span>
                        <span class="text-[#111811] dark:text-gray-200 text-sm font-medium leading-normal">
                            {{ employee.first_name|default:employee.user.email }}
                        </span>
                    </div>


                    <div class="flex p-4 @container bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex w-full flex-col gap-4 @[520px]:flex-row @[520px]:justify-between @[520px]:items-center">

                            <div class="flex gap-4">
                                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-24 w-24">
                                    {% if employee.gender == 2 %}
                                        <img class="rounded-full w-24 h-24 object-cover" src="{% static 'employee_female.jpg' %}" alt="Avatar kobiety"/>
                                    {% elif employee.gender == 1 %}
                                        <img class="rounded-full w-24 h-24 object-cover" src="{% static 'employee_male.jpg' %}" alt="Avatar mężczyzny"/>
                                    {% else %}
                                        <img class="rounded-full w-24 h-24 object-cover" src="{% static 'gander_null.jpg' %}" alt="Avatar neutralny"/>
                                    {% endif %}
                                </div>

                                <div class="flex flex-col justify-center">
                                    <p class="text-[#111811] dark:text-white text-3xl font-bold leading-tight tracking-[-0.015em]">
                                        {% if employee.first_name and employee.last_name %}
                                            {{ employee.first_name }} {{ employee.last_name }}
                                        {% else %}
                                            {{ employee.user.email }}
                                        {% endif %}
                                    </p>
                                    <p class="text-[#618961] dark:text-gray-400 text-base font-normal leading-normal mt-1">
                                        {{ employee.get_role_display|default:"Brak roli" }}
                                    </p>
                                    <p class="text-[#618961] dark:text-gray-400 text-sm font-normal leading-normal">
                                        {{ employee.user.email }}
                                        {% if employee.phone %} | {{ employee.phone }}{% endif %}
                                    </p>
                                </div>
                            </div>

                            <div class="flex w-full max-w-[480px] gap-3 @[480px]:w-auto">
                                {% if active_role == 'director' or active_role == 'teacher' and user.email == employee.user.email %}
                                    <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-100 dark:bg-gray-800 text-[#111811] dark:text-gray-200 text-sm font-bold leading-normal tracking-[0.015em] flex-1 @[480px]:flex-auto hover:bg-gray-200 dark:hover:bg-gray-700"
                                            onclick="location.href='{% url 'teacher_update' pk=employee.id %}'">
                                        <span class="truncate">EDYTUJ PROFIL</span>
                                    </button>
                                {% endif %}

                                {% if active_role == 'teacher' and user.email == employee.user.email %}
                                    <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-[#111811] text-sm font-bold leading-normal tracking-[0.015em] flex-1 @[480px]:flex-auto hover:opacity-90"
                                            onclick="location.href='{% url 'password_change' %}'">
                                        <span class="truncate">ZMIEŃ HASŁO</span>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">

                        <div class="pb-3">
                            <div class="flex border-b border-gray-200 dark:border-gray-700 px-4 gap-8">
                                <a @click.prevent="currentTab = 'overview'"
                                   :class="{ 'border-b-[#111811] dark:border-b-primary text-[#111811] dark:text-white': currentTab === 'overview', 'border-b-transparent text-[#618961] dark:text-gray-400': currentTab !== 'overview' }"
                                   href="#" class="flex flex-col items-center justify-center border-b-[3px] pb-[13px] pt-4 hover:text-[#111811] dark:hover:text-white transition-colors">
                                    <p class="text-sm font-bold leading-normal tracking-[0.015em]">Szczegóły</p>
                                </a>
                                <a @click.prevent="currentTab = 'groups'"
                                   :class="{ 'border-b-[#111811] dark:border-b-primary text-[#111811] dark:text-white': currentTab === 'groups', 'border-b-transparent text-[#618961] dark:text-gray-400': currentTab !== 'groups' }"
                                   href="#" class="flex flex-col items-center justify-center border-b-[3px] pb-[13px] pt-4 hover:text-[#111811] dark:hover:text-white transition-colors">
                                    <p class="text-sm font-bold leading-normal tracking-[0.015em]">Moja Grupa</p>
                                </a>
                            </div>
                        </div>

                        <div x-show="currentTab === 'overview'" class="grid grid-cols-1 lg:grid-cols-3 gap-6 pt-6">

                            <div class="lg:col-span-1 flex flex-col gap-6">
                                <div class="bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-bold text-[#111811] dark:text-white mb-4">Dane Osobiste</h3>
                                    <dl class="space-y-3">
                                        <div class="flex justify-between">
                                            <dt class="text-sm text-[#618961] dark:text-gray-400">Numer Kontaktowy</dt>
                                            <dd class="text-sm font-medium text-[#111811] dark:text-gray-200">
                                                {{ employee.phone|default:"Brak danych" }}
                                            </dd>
                                        </div>
                                        <div class="flex justify-between">
                                            <dt class="text-sm text-[#618961] dark:text-gray-400">Adres Zamieszkania</dt>
                                            <dd class="text-sm font-medium text-[#111811] dark:text-gray-200 text-right max-w-[50%]">
                                                {{ employee.address|default:"Brak danych" }}
                                            </dd>
                                        </div>
                                        <div class="flex justify-between">
                                            <dt class="text-sm text-[#618961] dark:text-gray-400">Miasto</dt>
                                            <dd class="text-sm font-medium text-[#111811] dark:text-gray-200">
                                                {{ employee.city|default:"Brak danych" }}
                                            </dd>
                                        </div>
                                        <div class="flex justify-between">
                                            <dt class="text-sm text-[#618961] dark:text-gray-400">Kod Pocztowy</dt>
                                            <dd class="text-sm font-medium text-[#111811] dark:text-gray-200">
                                                {{ employee.zip_code|default:"Brak danych" }}
                                            </dd>
                                        </div>
                                    </dl>
                                </div>

                                <div class="bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-bold text-[#111811] dark:text-white mb-4">Szczegóły Zatrudnienia</h3>
                                    <dl class="space-y-3">
                                        <div class="flex justify-between">
                                            <dt class="text-sm text-[#618961] dark:text-gray-400">Posada</dt>
                                            <dd class="text-sm font-medium text-[#111811] dark:text-gray-200">
                                                {{ employee.get_role_display|default:"Brak danych" }}
                                            </dd>
                                        </div>
                                        <div class="flex justify-between">
                                            <dt class="text-sm text-[#618961] dark:text-gray-400">Grupa (Główna)</dt>
                                            <dd class="text-sm font-medium text-[#111811] dark:text-gray-200">
                                                {{ employee.group|default:"Brak danych" }}
                                            </dd>
                                        </div>
                                        {% if active_role == 'director' or active_role == 'teacher' %}
                                            <div class="flex justify-between">
                                                <dt class="text-sm text-[#618961] dark:text-gray-400">Wynagrodzenie Miesięczne</dt>
                                                <dd class="text-sm font-medium text-[#111811] dark:text-gray-200">
                                                    {% if employee.salary %}{{ employee.salary }} zł{% else %}Brak danych{% endif %}
                                                </dd>
                                            </div>
                                        {% endif %}
                                        <div class="flex justify-between">
                                            <dt class="text-sm text-[#618961] dark:text-gray-400">Status</dt>
                                            <dd class="text-sm font-medium {% if employee.is_active %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                                {% if employee.is_active %}Aktywny{% else %}Nieaktywny{% endif %}
                                            </dd>
                                        </div>
                                    </dl>
                                </div>
                            </div>

                            <div class="lg:col-span-2 bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                                <h3 class="text-lg font-bold text-[#111811] dark:text-white mb-4">Notatki / Aktywność</h3>
                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                                    <p class="text-sm text-[#111811] dark:text-gray-300">
                                        Miejsce na notatki dyrektora, historię zmian lub ostatnią aktywność.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div x-show="currentTab === 'groups'" class="pt-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                                <div class="lg:col-span-1 space-y-6">
                                    <div class="bg-white dark:bg-gray-900 p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800">
                                        <div class="flex items-center justify-between mb-8">
                                            <h3 class="text-xl font-black uppercase tracking-tighter text-[#111811] dark:text-white">Moja Grupa</h3>
                                            <span class="p-2 bg-primary/10 rounded-xl text-primary">
                        <span class="material-symbols-outlined">diversity_3</span>
                    </span>
                                        </div>

                                        {% if employee.group %}
                                            <div class="space-y-6">
                                                <div>
                                                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Nazwa</p>
                                                    <p class="text-2xl font-black text-primary uppercase">{{ employee.group.name }}</p>
                                                </div>

                                                <div class="grid grid-cols-2 gap-4">
                                                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl">
                                                        <p class="text-[10px] font-black text-gray-400 uppercase">Dzieci</p>
                                                        <p class="text-xl font-black text-[#111811] dark:text-white">{{ employee.group.kid_set.count }}</p>
                                                    </div>
                                                </div>

                                                <div class="pt-4">
                                                    <a href="{% url 'group_details' pk=employee.group.pk %}"
                                                       class="w-full flex items-center justify-center gap-2 py-4 bg-primary text-[#111811] font-black uppercase text-xs rounded-2xl hover:opacity-90 transition-all shadow-lg shadow-primary/20">
                                                        <span class="material-symbols-outlined text-sm">visibility</span>
                                                        Szczegóły grupy
                                                    </a>
                                                </div>
                                            </div>
                                        {% else %}
                                            <p class="text-center py-10 text-gray-400 italic font-bold">Brak przypisanej grupy.</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="lg:col-span-2 bg-white dark:bg-gray-900 p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800">
                                    <h3 class="text-xl font-black uppercase tracking-tighter text-[#111811] dark:text-white mb-8">Lista Podopiecznych</h3>

                                    {% if kids %}
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {% for kid in kids %}
                                                <div class="group relative flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl border border-transparent hover:border-primary/30 transition-all">
                                                    <div class="flex items-center gap-4">
                                                        <div class="size-12 rounded-full bg-primary/10 flex items-center justify-center font-black text-primary">
                                                            {{ kid.first_name|slice:":1" }}
                                                        </div>
                                                        <div>
                                                            <p class="font-bold text-[#111811] dark:text-gray-200">{{ kid.first_name }} {{ kid.last_name }}</p>
                                                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Aktywny Uczeń</p>
                                                        </div>
                                                    </div>

                                                    <a href="{% url 'kid_details' pk=kid.pk %}"
                                                       class="p-2 bg-white dark:bg-gray-700 rounded-xl text-gray-400 hover:text-primary hover:shadow-md transition-all">
                                                        <span class="material-symbols-outlined">arrow_forward_ios</span>
                                                    </a>
                                                </div>
                                            {% endfor %}
                                        </div>

                                        {% if kids.has_other_pages %}
                                            <div class="mt-8 flex items-center justify-center gap-4">
                                                {% if kids.has_previous %}
                                                    <a href="?kids_page={{ kids.previous_page_number }}&currentTab=groups" class="p-3 bg-gray-100 dark:bg-gray-800 rounded-xl hover:bg-primary/20 transition-all">
                                                        <span class="material-symbols-outlined">chevron_left</span>
                                                    </a>
                                                {% endif %}

                                                <span class="text-xs font-black uppercase text-gray-400">Strona {{ kids.number }} z {{ kids.paginator.num_pages }}</span>

                                                {% if kids.has_next %}
                                                    <a href="?kids_page={{ kids.next_page_number }}&currentTab=groups" class="p-3 bg-gray-100 dark:bg-gray-800 rounded-xl hover:bg-primary/20 transition-all">
                                                        <span class="material-symbols-outlined">chevron_right</span>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                    {% else %}
                                        <div class="flex flex-col items-center justify-center py-20 bg-gray-50 dark:bg-gray-800 rounded-3xl border-2 border-dashed border-gray-200 dark:border-gray-700">
                                            <span class="material-symbols-outlined text-5xl text-gray-300 mb-4">person_search</span>
                                            <p class="text-gray-400 font-bold uppercase text-xs">Brak przypisanych dzieci do tej grupy</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div x-show="showAssignmentModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">

            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-2xl m-4 flex flex-col max-h-[90vh]"
                 @click.outside="showAssignmentModal = false">

                <form method="POST" action="{% url 'change_employee_group' pk=employee.pk %}">
                    {% csrf_token %}

                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-800">
                        <h2 class="text-xl font-bold text-[#111811] dark:text-white">Przypisz {{ employee.first_name|default:employee.user.email }} do Grupy</h2>
                        <button type="button" @click="showAssignmentModal = false" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                            <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">close</span>
                        </button>
                    </div>

                    <div class="p-6 flex-1 overflow-y-auto">
                        <p class="mb-4 text-gray-600 dark:text-gray-400">Wybierz grupę, do której chcesz przypisać pracownika. Obecny przydział zostanie nadpisany.</p>

                        <div class="space-y-4">
                            {% for group in groups_list %}
                                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <input class="size-5 rounded-full border-gray-300 dark:border-gray-600 text-primary focus:ring-primary/50 dark:bg-gray-900 dark:ring-offset-gray-900"
                                               id="group-{{ group.pk }}"
                                               type="radio"
                                               name="group_id"
                                               value="{{ group.pk }}"
                                               {% if employee.group.pk == group.pk %}checked{% endif %}/>
                                        <label class="font-medium text-[#111811] dark:text-gray-200" for="group-{{ group.pk }}">{{ group.name }}</label>
                                    </div>

                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        {% if employee.group.pk == group.pk %}
                                            (Aktualnie przypisany)
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-center text-gray-500 dark:text-gray-400">Brak dostępnych grup do przypisania.</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 p-6 border-t border-gray-200 dark:border-gray-800">
                        <button type="button" @click="showAssignmentModal = false" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-100 dark:bg-gray-800 text-[#111811] dark:text-gray-200 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-200 dark:hover:bg-gray-700">
                            <span class="truncate">Anuluj</span>
                        </button>
                        <button type="submit" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-[#111811] text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90">
                            <span class="truncate">Przypisz</span>
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    </body>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock content %}